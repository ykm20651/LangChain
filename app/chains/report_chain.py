
"""
ReportChain
- RAG ì»¨í…ìŠ¤íŠ¸ + ì‚¬ê³  ë°ì´í„°(JSON) â†’ ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œ ìë™ ìƒì„±
- ì‚¬ê³  ìœ í˜•ë³„ í…œí”Œë¦¿ ì²´ì¸ êµ¬ì„± (í™”ì¬, ìœ ë¥˜ìœ ì¶œ, ì¶©ëŒ, ì„ ì› ë¶€ìƒ)
"""

from typing import Dict, Any
from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.output_parsers import StrOutputParser


class ReportChain:
    """
    ì‚¬ê³ ìœ í˜•ë³„ ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œ ìƒì„±ìš© LangChain ì²´ì¸
    """

    def __init__(
        self,
        model: str = "gpt-4o-mini",
        temperature: float = 0.1,
        debug: bool = False,
    ):
        self.llm = ChatOpenAI(model=model, temperature=temperature)
        self.parser = StrOutputParser()
        self.debug = debug

        # ì‚¬ê³ ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ë¯¸ë¦¬ ì¤€ë¹„
        self.templates = {
            "fire": self._fire_template(),
            "oil_spill": self._oil_template(),
            "collision": self._collision_template(),
            "crew_injury": self._injury_template(),
        }

    # --------------------------------------------------
    # 1ï¸âƒ£ ê³µìš© ì¸í„°í˜ì´ìŠ¤
    # --------------------------------------------------
    def generate_report(
        self,
        incident_data: Dict[str, Any],
        rag_context: str = "",
        incident_type: str = "generic",
    ) -> str:
        """
        ì‚¬ê³ ìœ í˜•ì— ë§ëŠ” í”„ë¡¬í”„íŠ¸ ì„ íƒ í›„ LLM ì‹¤í–‰
        """
        formatted_incident = self._format_incident_data(incident_data)
        prompt_template = self._select_template(incident_type)

        # í”„ë¡¬í”„íŠ¸ ìƒì„±
        prompt = prompt_template.format(
            rag_context=rag_context,
            incident_data=formatted_incident,
        )

        if self.debug:
            print("ğŸ§¾ [í”„ë¡¬í”„íŠ¸ ì‹œì‘] ----------------------")
            print(prompt[:1200])
            print("... (ì´í•˜ ìƒëµ)")
            print("-----------------------------------------")

        # LLM ì‹¤í–‰
        response = self.llm.invoke(prompt)
        return self.parser.parse(response)

    # --------------------------------------------------
    # 2ï¸âƒ£ í…œí”Œë¦¿ ì„ íƒ ë¡œì§
    # --------------------------------------------------
    def _select_template(self, incident_type: str) -> PromptTemplate:
        key = incident_type.lower()
        if key in self.templates:
            return self.templates[key]
        else:
            return self._generic_template()

    # --------------------------------------------------
    # 3ï¸âƒ£ ì‚¬ê³ ìœ í˜•ë³„ í…œí”Œë¦¿ ì •ì˜
    # --------------------------------------------------
    def _fire_template(self) -> PromptTemplate:
        return PromptTemplate.from_template(
            """
ë‹¹ì‹ ì€ ì„ ë°• ë³´í—˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•„ë˜ [ì»¨í…ìŠ¤íŠ¸]ë¥¼ ê·¼ê±°ë¡œ ì„ ë°• í™”ì¬ì‚¬ê³  ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.
ëª¨ë¥´ë©´ "ê·¼ê±° ë¶€ì¡±"ì´ë¼ê³  ëª…ì‹œí•˜ì„¸ìš”.

[ì»¨í…ìŠ¤íŠ¸]
{rag_context}

[ì‚¬ê³  ì •ë³´]
{incident_data}

# ì„ ë°• í™”ì¬ì‚¬ê³  ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œ

## 1. ì‚¬ê³  ê°œìš”
- í™”ì¬ ë°œìƒ ì¼ì‹œ, ìœ„ì¹˜, ì„ ë°•ëª…, ì„ ì£¼, í™”ì¬ ì›ì¸(ì „ê¸°, ì—°ë£Œ, ì¸í™”ë¬¼ì§ˆ ë“±)
## 2. ì‚¬ê³  ê²½ìœ„
- í™”ì¬ ë°œìƒë¶€í„° ì§„ì••ê¹Œì§€ì˜ ê²½ê³¼ ìš”ì•½
## 3. í”¼í•´ í˜„í™©
- ì¸ì  í”¼í•´, ì„ ì²´ ì†ìƒ, í™”ë¬¼ í”¼í•´, í™˜ê²½ í”¼í•´
## 4. ë²•ë ¹ ë° ì•½ê´€ ê·¼ê±°
- ê´€ë ¨ ë²•ë¥ , IMO ê¸°ì¤€, ë³´í—˜ì•½ê´€ í™”ì¬ì¡°í•­ ê·¼ê±°
## 5. ë³´í—˜ê¸ˆ ì‚°ì • ê·¼ê±°
- ì†í•´ì•¡, ê³µì œì•¡, ë©´ì±…ì‚¬ìœ  ì—¬ë¶€
## 6. ê²°ë¡  ë° ê¶Œê³ ì‚¬í•­
(ë§ˆì§€ë§‰ì— ì°¸ê³  ë¬¸ì„œ ì¶œì²˜ ìš”ì•½)
"""
        )

    def _oil_template(self) -> PromptTemplate:
        return PromptTemplate.from_template(
            """
ë‹¹ì‹ ì€ í•´ì–‘ì˜¤ì—¼ ì‚¬ê³  ì²˜ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì•„ë˜ [ì»¨í…ìŠ¤íŠ¸]ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìœ ë¥˜ìœ ì¶œ ì‚¬ê³ ì˜ ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

[ì»¨í…ìŠ¤íŠ¸]
{rag_context}

[ì‚¬ê³  ì •ë³´]
{incident_data}

# ìœ ë¥˜ìœ ì¶œ ì‚¬ê³  ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œ

## 1. ì‚¬ê³  ê°œìš”
- ë°œìƒ ì¼ì‹œ, ì„ ë°• ì •ë³´, í•´ìƒ ìœ„ì¹˜, ê¸°ìƒì¡°ê±´, ìœ ë¥˜ ì¢…ë¥˜/ìœ ì¶œëŸ‰
## 2. ì‚¬ê³  ê²½ìœ„
- ìœ ì¶œ ì›ì¸, ë°©ì œ ì¡°ì¹˜, í™˜ê²½ ì˜í–¥
## 3. í”¼í•´ í˜„í™©
- í•´ì–‘ì˜¤ì—¼ ë²”ìœ„, í•´ì–‘ìƒë¬¼ í”¼í•´, ë°©ì œë¹„ìš©
## 4. ë²•ë ¹ ë° ê·¼ê±°
- í•´ì–‘í™˜ê²½ê´€ë¦¬ë²•, MARPOL í˜‘ì•½ ê´€ë ¨ ì¡°í•­
## 5. ë³´í—˜ê¸ˆ ì‚°ì • ê·¼ê±°
- ë³µêµ¬ë¹„, ë°©ì œë¹„, í”¼í•´ë³´ìƒí•­ëª©
## 6. ê²°ë¡  ë° ê¶Œê³ ì‚¬í•­
(ì°¸ê³  ë¬¸ì„œ ì¶œì²˜ í¬í•¨)
"""
        )

    def _collision_template(self) -> PromptTemplate:
        return PromptTemplate.from_template(
            """
ë‹¹ì‹ ì€ í•´ì‚¬ì•ˆì „ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì•„ë˜ [ì»¨í…ìŠ¤íŠ¸]ë¥¼ ì°¸ì¡°í•˜ì—¬ ì„ ë°• ì¶©ëŒì‚¬ê³  ë³´í—˜ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

[ì»¨í…ìŠ¤íŠ¸]
{rag_context}

[ì‚¬ê³  ì •ë³´]
{incident_data}

# ì„ ë°• ì¶©ëŒì‚¬ê³  ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œ

## 1. ì‚¬ê³  ê°œìš”
- ì‚¬ê³  ì¼ì‹œ, ìœ„ì¹˜, ì¶©ëŒ ì„ ë°•, í•­ë¡œ, ê¸°ìƒ
## 2. ì‚¬ê³  ê²½ìœ„
- ì¶©ëŒ ì „í›„ ìƒí™©, í•­í•´ê¸°ë¡ ìš”ì•½
## 3. í”¼í•´ í˜„í™©
- ì„ ì²´ ì†ìƒ, í™”ë¬¼ íŒŒì†, ì¸ëª…í”¼í•´
## 4. ë²•ë ¹ ë° ì•½ê´€ ê·¼ê±°
- í•´ì‚¬ì•ˆì „ë²•, êµ­ì œì¶©ëŒì˜ˆë°©ê·œì¹™(COLREGS) ê´€ë ¨ ì¡°í•­
## 5. ë³´í—˜ê¸ˆ ì‚°ì • ê·¼ê±°
- ìˆ˜ë¦¬ë¹„, ì •ë°•ì†ì‹¤ë¹„ìš© ë“±
## 6. ê²°ë¡  ë° í–¥í›„ ì˜ˆë°©ì¡°ì¹˜
"""
        )

    def _injury_template(self) -> PromptTemplate:
        return PromptTemplate.from_template(
            """
ë‹¹ì‹ ì€ ì„ ì› ì¬í•´ ë³´ìƒ ì „ë¬¸ ì‹¬ì‚¬ê´€ì…ë‹ˆë‹¤.
ì•„ë˜ [ì»¨í…ìŠ¤íŠ¸]ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì„ ì› ë¶€ìƒì‚¬ê³  ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

[ì»¨í…ìŠ¤íŠ¸]
{rag_context}

[ì‚¬ê³  ì •ë³´]
{incident_data}

# ì„ ì› ë¶€ìƒì‚¬ê³  ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œ

## 1. ì‚¬ê³  ê°œìš”
- ë¶€ìƒì, ë°œìƒì¥ì†Œ, ì‘ì—…ìƒí™©, ì„ ë°•ì •ë³´
## 2. ì‚¬ê³  ê²½ìœ„
- ë¶€ìƒ ì›ì¸, êµ¬ì¡°ì¡°ì¹˜, ì˜ë£Œì¡°ì¹˜
## 3. í”¼í•´ í˜„í™©
- ë¶€ìƒ ì •ë„, ì¹˜ë£Œê¸°ê°„, ë³µê·€ ê°€ëŠ¥ ì—¬ë¶€
## 4. ë²•ë ¹ ë° ì•½ê´€ ê·¼ê±°
- ì„ ì›ë²•, ì‚°ì—…ì¬í•´ë³´ìƒë³´í—˜ë²• ê´€ë ¨ ì¡°í•­
## 5. ë³´í—˜ê¸ˆ ì‚°ì • ê·¼ê±°
- ì¹˜ë£Œë¹„, íœ´ì—…ê¸‰ì—¬, ì¥í•´ê¸‰ì—¬ ì‚°ì •
## 6. ê²°ë¡  ë° ê¶Œê³ ì‚¬í•­
"""
        )

    def _generic_template(self) -> PromptTemplate:
        return PromptTemplate.from_template(
            """
ì•„ë˜ [ì»¨í…ìŠ¤íŠ¸]ì™€ [ì‚¬ê³  ì •ë³´]ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¼ë°˜ ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

[ì»¨í…ìŠ¤íŠ¸]
{rag_context}

[ì‚¬ê³  ì •ë³´]
{incident_data}

# ì¼ë°˜ ë³´í—˜ ì²­êµ¬ ë³´ê³ ì„œ

## 1. ì‚¬ê³  ê°œìš”
## 2. ì‚¬ê³  ê²½ìœ„
## 3. í”¼í•´ í˜„í™©
## 4. ë²•ë ¹ ë° ì•½ê´€ ê·¼ê±°
## 5. ë³´í—˜ê¸ˆ ì‚°ì • ê·¼ê±°
## 6. ê²°ë¡ 
"""
        )

    # --------------------------------------------------
    # 4ï¸âƒ£ ë°ì´í„° í¬ë§·íŒ…
    # --------------------------------------------------
    def _format_incident_data(self, data: Dict[str, Any]) -> str:
        """
        JSON ì‚¬ê³ ë°ì´í„°ë¥¼ ì‚¬ëŒì´ ì½ê¸° ì‰¬ìš´ ë¼ì¸ í¬ë§·ìœ¼ë¡œ ë³€í™˜
        """
        lines = []
        for key, val in data.items():
            if val is not None and val != "":
                lines.append(f"- {key}: {val}")
        return "\n".join(lines) if lines else "(ì œê³µëœ ë°ì´í„° ì—†ìŒ)"
